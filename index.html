<!DOCTYPE html>
<html lang="es">

<head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clasificaci√≥n General CK</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="manifest" href="./manifest.json">

    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <nav class="navbar">
        <a href="./" class="nav-link">üèÜ Clasificaci√≥n</a>
        <a href="./inscripcion/" class="nav-link">üìù Preinscripci√≥n</a>
        <a href="./sorteo/" class="nav-link">üèéÔ∏è Sorteo</a>
    </nav>
    <div class="container">
        <h1><i class="fa-solid fa-trophy"></i> Clasificaci√≥n</h1>

        <div id="podium-container" class="podium"></div>

        <div id="list-container" class="list"></div>

    </div>


    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN
        // ==========================================
        // Se han usado comillas invertidas (\`) para evitar cualquier problema de caracteres.
        const SHEET_URL = `https://script.google.com/macros/s/AKfycbzncwITyoZ45XEf4bVf_2dctYAaMO6eaL-aaRt5EhiDpBeS0BjqSXaG0gimgItWF4spfw/exec`;
        // ==========================================
        // üöÄ L√ìGICA DE CARGA DE DATOS
        // ==========================================

        async function fetchLeaderboardData() {
            const podiumContainer = document.getElementById('podium-container');
            const listContainer = document.getElementById('list-container');

            listContainer.innerHTML = '<div style="text-align:center; color:#94a3b8;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando datos del campeonato...</div>';

            try {
                const response = await fetch(SHEET_URL);
                const drivers = await response.json();
                renderLeaderboard(drivers);

            } catch (error) {
                console.error("Error al cargar el Google Sheet:", error);
                listContainer.innerHTML = '<div style="text-align:center; color:#ef4444;">Error al cargar los datos. Recarga la app.</div>';
            }
        }

        // Funci√≥n auxiliar para leer el CSV crudo
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const drivers = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',');

                if (parts.length >= 3) {
                    drivers.push({
                        name: parts[0].trim(),
                        team: parts[1].trim(),
                        points: parseInt(parts[2].trim()) || 0,
                        photo: parts[3] ? parts[3].trim() : "https://www.w3schools.com/howto/img_avatar.png"
                    });
                }
            }
            return drivers;
        }

        // ==========================================
        // üé® RENDERIZADO (CON ENLACES AL PERFIL)
        // ==========================================

        function renderLeaderboard(driversData) {
            const podiumContainer = document.getElementById('podium-container');
            const listContainer = document.getElementById('list-container');

            // Limpiar contenedores
            podiumContainer.innerHTML = '';
            listContainer.innerHTML = '';

            // 1. Ordenar pilotos por puntos (Mayor a menor)
            const sortedDrivers = driversData.sort((a, b) => b.points - a.points);

            // 2. Separar Top 3 del resto
            const top3 = sortedDrivers.slice(0, 3);
            const rest = sortedDrivers.slice(3);

            // 3. Renderizar Podio (Top 3)
            let podiumHTML = '';

            top3.forEach((driver, index) => {
                const rank = index + 1;
                let crownIcon = '';
                if (rank === 1) crownIcon = '<i class="fa-solid fa-medal crown" style="color: gold;"></i>';
                if (rank === 2) crownIcon = '<i class="fa-solid fa-medal crown" style="color: silver;"></i>';
                if (rank === 3) crownIcon = '<i class="fa-solid fa-medal crown" style="color: bronze;"></i>';

                const driverNameUrl = encodeURIComponent(driver.name);
                // Usando Template Literals para la inyecci√≥n de HTML con ${}
                podiumHTML += `
                    <div class="podium-card rank-${rank}">
                    ${crownIcon}
                        <img src="${driver.photo}" alt="${driver.name}" class="avatar">
                        <div class="podium-content">
                        <div class="p-name">${driver.name}</div>
                        <div class="p-team">${driver.team}</div>
                        <div class="p-points">${driver.points} PTS</div>
                        </div>
                    </div>
                `;
            });
            podiumContainer.innerHTML = podiumHTML;

            // 4. Renderizar Lista (Resto)
            let listHTML = '';

            rest.forEach((driver, index) => {
                const rank = index + 4;

                const driverNameUrl = encodeURIComponent(driver.name);
                listHTML += `
                    <a href="./profile/index.html?driver=${driverNameUrl}" class="list-item-link">
                    <div class="list-item">
                    <div class="rank-num">${rank}</div>
                    <img src="${driver.photo}" alt="${driver.name}" class="mini-avatar">
                    <div class="info">
                        <div class="l-name">${driver.name}</div>
                        <div class="l-team">${driver.team}</div>
                    </div>
                    <div class="l-points">${driver.points} <span>PTS</span></div>
                    </div>
                    </a>
                `;
            });
            listContainer.innerHTML = listHTML;
        }

        // Iniciar carga al abrir la web
        document.addEventListener('DOMContentLoaded', fetchLeaderboardData);

        // ==========================================
        // üåê REGISTRO DEL SERVICE WORKER (PWA)
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro del SW:', error);
                    });
            });
        }
        // ==========================================
    </script>

</body>

</html>