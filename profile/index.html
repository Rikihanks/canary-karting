<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil del Piloto | CK</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="container">
        <a href="../" class="back-link"><i class="fa-solid fa-arrow-left"></i> Volver a la
            Clasificaci贸n</a>

        <div id="profile-content">
        </div>
    </div>

    <script>
        // ==========================================
        // 锔 CONFIGURACIN
        // ==========================================

        // PEGA AQU EL ENLACE "PUBLICAR EN LA WEB" (FORMATO CSV) DE TU GOOGLE SHEET
        const GOOGLE_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlPsGq-SypD4WPitvnR7JcluA8_6-5ePtuzyf5zFGJ31eppN55iUIHsKo0oduOZ9AVyVTf6VkPvTyu/pub?output=csv";


        // 2. USAMOS ESTE ENLACE (Con el proxy para que funcione en local)
        // Se han usado comillas invertidas (\`) para evitar cualquier problema de caracteres.
        const SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_CSV_LINK)}`;

        // ==========================================
        //  LGICA DE CARGA Y RENDERIZADO DEL PERFIL
        // ==========================================

        // 1. Obtener el nombre del piloto de la URL
        function getDriverNameFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('driver');
        }

        // Funci贸n auxiliar para leer el CSV crudo
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const drivers = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',');

                if (parts.length >= 3) {
                    drivers.push({
                        name: parts[0].trim(),
                        team: parts[1].trim(),
                        points: parseInt(parts[2].trim()) || 0,
                        photo: parts[3] ? parts[3].trim() : "https://www.w3schools.com/howto/img_avatar.png"
                    });
                }
            }
            return drivers;
        }

        // 2. Renderizar el perfil
        function renderProfile(driver) {
            const contentDiv = document.getElementById('profile-content');

            if (!driver) {
                contentDiv.innerHTML = '<div class="profile-card"><h1 style="color:#ef4444;">隆Error! Piloto no encontrado.</h1></div>';
                return;
            }

            const profileHTML = `
                <div class="profile-card">
                    <img src="${driver.photo}" alt="${driver.name}" class="avatar-lg">
                    <div class="name-lg">${driver.name}</div>
                    <div class="team-lg">${driver.team}</div>

                    <div class="points-box">
                        <h2>PUNTOS TOTALES</h2>
                        <div class="points-lg">${driver.points}</div>
                    </div>
                    
                </div>
            `;

            contentDiv.innerHTML = profileHTML;
        }

        // 3. Funci贸n principal de carga
        async function loadDriverProfile() {
            const driverName = getDriverNameFromUrl();
            const contentDiv = document.getElementById('profile-content');

            if (!driverName) {
                contentDiv.innerHTML = '<div class="profile-card"><h1 style="color:#ef4444;">Error: No se especific贸 un piloto.</h1></div>';
                return;
            }

            contentDiv.innerHTML = '<div style="text-align:center; color:#94a3b8;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando perfil...</div>';

            try {
                const response = await fetch(SHEET_URL);
                const data = await response.text();
                const drivers = parseCSV(data);

                // Buscar al piloto. Se usa el nombre (decodeURIComponent) como clave.
                const targetDriver = drivers.find(d => d.name === decodeURIComponent(driverName));

                renderProfile(targetDriver);

            } catch (error) {
                console.error("Error al cargar el Google Sheet:", error);
                contentDiv.innerHTML = '<div class="profile-card"><h1 style="color:#ef4444;">Error de conexi贸n. Int茅ntalo de nuevo.</h1></div>';
            }
        }

        // Iniciar al cargar la p谩gina
        document.addEventListener('DOMContentLoaded', loadDriverProfile);
    </script>

</body>

</html>