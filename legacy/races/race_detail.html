<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Detalle de Carrera | CK</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles_carreras.css">
</head>

<body>
    <nav class="navbar-wrapper">
        <div class="navbar-top">
            <button class="menu-toggle" aria-controls="mobile-menu" aria-expanded="false">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="navbar-title"><i class="fa-solid fa-trophy"></i> Detalles del evento</span>
        </div>

        <div id="mobile-menu" class="navbar-menu" data-visible="false">
            <div class="menu-header">
                <img src="../icons/50.png" alt="icon" class="app-icon"> <span class="app-name">Canary Karting</span>
            </div>
            <a href="../" class="nav-link">üèÜ Clasificaci√≥n</a>
            <a href="../inscripcion/" class="nav-link">üìù Preinscripci√≥n</a>
            <a href="../sorteo/" class="nav-link"><i class="fa-solid fa-dice"></i> Sorteo</a>
            <a href="../races/" class="nav-link">üèéÔ∏è Carreras</a>
        </div>
    </nav>

    <div class="container">
        <div id="race-info"></div>

        <div id="loading-spinner" class="loading-message">
            <i class="fa-solid fa-spinner fa-spin"></i> Cargando resultados...
        </div>

        <section id="clasificacion-section" style="display:none;">
            <h2>‚è±Ô∏è Qualy</h2>
            <div id="clasificacion-table" class="results-table-container"></div>
        </section>

        <section id="resultado-section" style="display:none;">
            <h2>üèÅ Resultado Final</h2>
            <div id="resultado-table" class="results-table-container"></div>
        </section>

        <div id="error-message" class="error-message" style="display:none;"></div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN DE URLS (üö® REEMPLAZAR ESTAS 2 URLS)
        // ==========================================

        const CLASI_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTq8sBXfzKkBmGEUxaqB57exxTbF_0yYsHVaRsQ2F7HzCXoMVK8zW8630R4vtSvRn590pj-N65vFQek/pub?gid=25895170&single=true&output=csv";
        const RESULT_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTq8sBXfzKkBmGEUxaqB57exxTbF_0yYsHVaRsQ2F7HzCXoMVK8zW8630R4vtSvRn590pj-N65vFQek/pub?gid=1225782575&single=true&output=csv";

        const CLASI_URL = `https://corsproxy.io/?url=${encodeURIComponent(CLASI_CSV_LINK)}`;
        const RESULT_URL = `https://corsproxy.io/?url=${encodeURIComponent(RESULT_CSV_LINK)}`;

        // ==========================================
        // üöÄ FUNCIONES DE UTILIDAD Y PARSEO
        // ==========================================

        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        }

        /**
         * Parsea los CSVs de Clasificaci√≥n/Resultado.
         * Estructura esperada: PILOTO, POSICION, ID_CIRCUITO, FECHA
         */
        function parseResultsCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const results = [];

            for (let i = 1; i < lines.length; i++) {
                // Usamos la coma (,) como separador est√°ndar.
                const parts = lines[i].split(',');

                if (parts.length >= 4) {
                    results.push({
                        piloto: parts[0] ? parts[0].trim() : 'Desconocido',
                        posicion: parseInt(parts[1].trim()) || 99,
                        id_circuito: parts[2] ? parts[2].trim() : '',
                        fecha: parts[3] ? parts[3].trim() : '',
                    });
                }
            }
            return results;
        }

        // ==========================================
        // üèÅ FILTRADO Y GENERACI√ìN DE CONTENIDO
        // ==========================================

        function generateContentHTML(data, type) {
            if (data.length === 0) {
                return `<p class="empty-message">No hay datos de ${type} para esta carrera.</p>`;
            }

            // Ordenar por Posici√≥n (ascendente)
            data.sort((a, b) => a.posicion - b.posicion);

            let html = '<div class="grid-container">';
            data.forEach(item => {
                let posClass = item.posicion === 1 ? 'pos-1' : '';
                // Aplica el estilo de podio para 2 y 3 solo en los resultados de carrera
                if (type === 'resultados' && item.posicion > 1 && item.posicion <= 3) {
                    posClass += ' pos-podium';
                }

                const encodedPilotName = encodeURIComponent(item.piloto);
                const profileLink = `../profile/index.html?driver=${encodedPilotName}`;

                html += `
                <div class="grid-item ${posClass}" data-pos="${item.posicion}">
                    <div class="grid-piloto-container">
                        <span class="grid-pos">${item.posicion}.</span>
                        <a href="${profileLink}" class="grid-piloto-link"> 
                            <span class="grid-piloto">${item.piloto}</span>
                        </a>
                    </div>
                </div>
            `;
            });
            html += '</div>';
            return html;
        }

        async function loadRaceDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const circuitName = urlParams.get('circuitName');
            const date = urlParams.get('date');

            const spinner = document.getElementById('loading-spinner');
            const errorDiv = document.getElementById('error-message');

            if (!id || !date) {
                errorDiv.textContent = 'Error: Faltan par√°metros de circuito o fecha.';
                errorDiv.style.display = 'block';
                spinner.style.display = 'none';
                return;
            }

            try {
                // 1. Cargar ambos CSVs simult√°neamente
                const [clasiData, resultData] = await Promise.all([
                    fetchCSV(CLASI_URL),
                    fetchCSV(RESULT_URL)
                ]);

                const allClasi = parseResultsCSV(clasiData);
                const allResults = parseResultsCSV(resultData);
                console.log(allClasi);
                console.log(allResults);


                // 2. Filtrar por ID y FECHA
                const filteredClasi = allClasi.filter(
                    r => r.id_circuito === id && r.fecha === date
                );
                const filteredResults = allResults.filter(
                    r => r.id_circuito === id && r.fecha === date
                );

                // 3. Renderizar T√≠tulo e Info (usando el nombre del circuito si estuviera disponible, o solo la fecha)
                document.getElementById('race-info').innerHTML = `<p class="race-info-date">Fecha: <strong>${date}</strong> <br> Circuito: ${circuitName}</p>`;


                // 4. Renderizar Contenido (Usando la nueva funci√≥n)
                document.getElementById('clasificacion-table').innerHTML = generateContentHTML(filteredClasi, 'clasificacion');
                document.getElementById('resultado-table').innerHTML = generateContentHTML(filteredResults, 'resultados');

                document.getElementById('clasificacion-section').style.display = 'block';
                document.getElementById('resultado-section').style.display = 'block';

            } catch (error) {
                console.error("Error al cargar o filtrar datos:", error);
                errorDiv.textContent = 'Error al cargar los datos de la carrera. Verifica las URLs y el formato CSV.';
                errorDiv.style.display = 'block';
            } finally {
                spinner.style.display = 'none';
            }
        }

        function toggleMenu() {
            const toggleButton = document.querySelector('.menu-toggle');
            const navMenu = document.getElementById('mobile-menu');

            // Funci√≥n para cerrar el men√∫
            const closeMenu = () => {
                navMenu.setAttribute('data-visible', 'false');
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleButton.querySelector('i').className = 'fa-solid fa-bars';
            };

            // Funci√≥n para abrir/cerrar al hacer clic en el bot√≥n de hamburguesa
            const toggleMenu = () => {
                const isVisible = navMenu.getAttribute('data-visible') === 'true';

                navMenu.setAttribute('data-visible', String(!isVisible));
                toggleButton.setAttribute('aria-expanded', String(!isVisible));

                // Cambia el icono (de hamburguesa a X y viceversa)
                toggleButton.querySelector('i').className = isVisible ? 'fa-solid fa-bars' : '';
            };

            if (toggleButton && navMenu) {
                toggleButton.addEventListener('click', toggleMenu);

                // üÜï NUEVA L√ìGICA: Cerrar al hacer clic fuera del men√∫ o del bot√≥n
                document.addEventListener('click', (event) => {
                    const isMenuVisible = navMenu.getAttribute('data-visible') === 'true';

                    // Si el men√∫ NO est√° abierto, no hacemos nada.
                    if (!isMenuVisible) {
                        return;
                    }

                    // Si el clic NO fue dentro del bot√≥n de hamburguesa Y NO fue dentro del men√∫ mismo:
                    if (!navMenu.contains(event.target) && !toggleButton.contains(event.target)) {
                        closeMenu();
                    }
                });

                // Opcional: Cerrar el men√∫ si se hace clic en uno de los enlaces
                // Esto asegura que el men√∫ se oculte despu√©s de la navegaci√≥n.
                const navLinks = navMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', closeMenu);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', loadRaceDetails);
        document.addEventListener('DOMContentLoaded', toggleMenu);
    </script>
</body>

</html>