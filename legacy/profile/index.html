<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil del Piloto | CK</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
    <link rel="manifest" href="/canary-karting/manifest.json">
</head>

<body>
    <nav class="navbar-wrapper">
        <div class="navbar-top">
            <button class="menu-toggle" aria-controls="mobile-menu" aria-expanded="false">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="navbar-title"><i class="fa-solid fa-trophy"></i> Piloto</span>
        </div>

        <div id="mobile-menu" class="navbar-menu" data-visible="false">
            <div class="menu-header">
                <img src="../icons/50.png" alt="icon" class="app-icon"> <span class="app-name">Canary Karting</span>
            </div>
            <a href="../" class="nav-link">üèÜ Clasificaci√≥n</a>
            <a href="../inscripcion/" class="nav-link">üìù Preinscripci√≥n</a>
            <a href="../sorteo/" class="nav-link"><i class="fa-solid fa-dice"></i> Sorteo</a>
            <a href="../races/" class="nav-link">üèéÔ∏è Carreras</a>
        </div>
    </nav>

    <div class="container">
        <div id="profile-content">
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title"></h3>
            <div id="modal-body-content">
            </div>
        </div>
    </div>
    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN DE URLS
        // ==========================================

        // 1. Enlace CSV de CLASIFICACI√ìN GENERAL (Hoja r√°pida, con stats totales)
        const GOOGLE_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlPsGq-SypD4WPitvnR7JcluA8_6-5ePtuzyf5zFGJ31eppN55iUIHsKo0oduOZ9AVyVTf6VkPvTyu/pub?output=csv";
        const SHEET_URL = `https://corsproxy.io/?url=${encodeURIComponent(GOOGLE_CSV_LINK)}`;

        // 2. Enlace CSV de RESULTADOS DE CARRERA (Hoja detallada por evento)
        const RESULTS_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP2AF0yixedvzkQcGkkLxnAP4fKl26f46dCFHdL6f11_QbeZP6NHLDshKqBkKtZdYLkyH8Rqrtedp5/pub?output=csv"; // <--- ¬°REEMPLAZA ESTO!
        const RESULTS_URL = `https://corsproxy.io/?url=${encodeURIComponent(RESULTS_CSV_LINK)}`;

        // Variable global para guardar el historial y usarlo en la modal
        let CURRENT_DRIVER_HISTORY = [];

        // ==========================================
        // üöÄ FUNCIONES DE UTILIDAD
        // ==========================================

        function getDriverNameFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return decodeURIComponent(urlParams.get('driver') || '');
        }

        /**
         * Funci√≥n para manejo de errores y reintento (MEJORA DE ESTABILIDAD)
         */
        async function fetchWithRetry(url, maxRetries = 3) {
            const timestamp = new Date().getTime();
            const cacheBusterUrl = `${url}&_t=${timestamp}`;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(cacheBusterUrl);
                    if (response.ok) return response;
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    } else {
                        throw new Error(`Fallo de conexi√≥n despu√©s de ${maxRetries} intentos.`);
                    }
                }
            }
        }

        /**
         * Funci√≥n auxiliar para leer el CSV crudo de Clasificaci√≥n General
         */
        function parseClasificacionCSV(csvText) {
            const lines = csvText.split('\n');
            const drivers = [];
            // Asumo que la Hoja de Clasificaci√≥n tiene: Nombre, Equipo, Puntos, Foto, Podiums, Poles, Best_Lap, Wins, Division
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const parts = line.split(',');

                if (parts.length >= 8) {
                    drivers.push({
                        name: parts[0] ? parts[0].trim() : '',
                        team: parts[1] ? parts[1].trim() : '',
                        points: parseInt(parts[2].trim()) || 0,
                        photo: parts[3] ? parts[3].trim() : "https://www.w3schools.com/howto/img_avatar.png",
                        podiums: parseInt(parts[4].trim()) || 0,
                        poles: parseInt(parts[5].trim()) || 0,
                        wins: parseInt(parts[6].trim()) || 0,
                        division: parts[7] ? parts[7].trim() : "Novato",
                    });
                }
            }
            return drivers;
        }

        /**
         * Funci√≥n auxiliar para leer el CSV crudo de Resultados de Carrera.
         * Estructura: ID_Piloto, Nombre, Carrera, Fecha, Posici√≥n Final, Posici√≥n Clasificaci√≥n, Vuelta R√°pida, Condici√≥n, Puntos Obtenidos
         */
        function parseResultsCSV(csvText) {
            const lines = csvText.split('\n');
            const results = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const parts = line.split(',');

                if (parts.length >= 9) {
                    results.push({
                        id: parts[0].trim(),
                        name: parts[1].trim(), // Nombre del piloto
                        race: parts[2].trim(), // Nombre de la carrera/ronda
                        date: parts[3].trim(),
                        position: parseInt(parts[4].trim()) || 0, // Posici√≥n Final (1, 2, 3...)
                        pole_pos: parseInt(parts[5].trim()) || 0, // Posici√≥n de Clasificaci√≥n/Salida
                        fastest_lap: parts[6] ? parts[6].trim() : "N/A", // Vuelta R√°pida (el tiempo, ej: 45.123)
                        condition: parts[7].trim(), // Condici√≥n (Seco, Mojado)
                        points_gained: parseInt(parts[8].trim()) || 0,
                    });
                }
            }
            return results;
        }


        // ==========================================
        // üèÅ FUNCIONES DE GENERACI√ìN DE HTML (LISTAS PARA LA MODAL)
        // ==========================================

        function generateFastestLapHTML(driverRaceHistory) {
            const validLaps = driverRaceHistory.filter(event =>
                event.fastest_lap && event.fastest_lap !== 'N/A' && event.fastest_lap.trim() !== '-'
            );

            if (validLaps.length === 0) {
                return `<div class="event-detail-empty">No hay tiempos de vuelta r√°pida registrados.</div>`;
            }

            validLaps.sort((a, b) => a.fastest_lap.localeCompare(b.fastest_lap));

            let html = `<ul class="event-list">`;
            validLaps.forEach(event => {
                const isBestOverall = (event === validLaps[0]);

                html += `
                <li class="event-item ${isBestOverall ? 'best-lap-overall' : ''}">
                    <div class="event-header">
                        <span class="event-race-name">${event.race} (${event.date})</span>
                        <span class="event-points">${isBestOverall ? 'MEJOR HIST√ìRICA' : 'VUELTA R√ÅPIDA'}</span>
                    </div>
                    <div class="event-body">
                        <p><strong>Tiempo de Vuelta:</strong> <span style="font-weight: 800; color: ${isBestOverall ? '#9728c5' : '#10b981'};">${event.fastest_lap}</span></p>
                        <p><strong>Condici√≥n:</strong> ${event.condition}</p>
                        <p>Posici√≥n Final: ${event.position}¬∫</p>
                    </div>
                </li>
                `;
            });
            html += `</ul>`;
            return html;
        }

        function generateEventListHTML(events, type) {
            if (events.length === 0) return `<div class="event-detail-empty">No hay ${type} registradas a√∫n.</div>`;

            let html = `<ul class="event-list">`;
            events.forEach(event => {
                html += `
                    <li class="event-item">
                        <div class="event-header">
                            <span class="event-race-name">${event.race} (${event.date})</span>
                            <span class="event-points">${event.points_gained} PTS</span>
                        </div>
                        <div class="event-body">
                            <p><strong>Posici√≥n Final:</strong> ${event.position}¬∫</p>
                            <p><strong>Posici√≥n de salida:</strong> P${event.pole_pos}</p>
                            <p><strong>Condici√≥n:</strong> ${event.condition}</p>
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
            return html;
        }

        // ==========================================
        // üèÅ L√ìGICA DE RENDER Y MODAL
        // ==========================================

        function renderProfile(driverStats, driverRaceHistory) {
            const contentDiv = document.getElementById('profile-content');

            // Los datos se filtran y el HTML se genera al abrir la modal,
            // pero mantenemos el filtrado aqu√≠ para actualizar el conteo de la tarjeta.
            const victories = driverRaceHistory.filter(r => r.position === 1);
            const podiums = driverRaceHistory.filter(r => r.position > 0 && r.position <= 3);
            const poles = driverRaceHistory.filter(r => r.pole_pos === 1);
            const fastestLaps = driverRaceHistory.filter(r => r.fastest_lap); // Contar carreras con vuelta r√°pida

            const profileHTML = `
                <div class="profile-card">
                    <img src="${driverStats.photo}" alt="${driverStats.name}" class="avatar-lg">
                    <div class="name-lg">${driverStats.name}</div>
                    <div class="team-lg">${driverStats.team}</div>
                    <div class="division-lg">
                        <i class="fa-solid fa-medal division-icon"></i> ${driverStats.division} Division
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item toggle-modal" data-list="victories">
                            <i class="fa-solid fa-trophy stat-icon"></i>
                            <div class="stat-value">${victories.length}</div>
                            <div class="stat-label">Victorias</div>
                        </div>
                        <div class="stat-item toggle-modal" data-list="podiums">
                            <i class="fa-solid fa-medal stat-icon"></i>
                            <div class="stat-value">${podiums.length}</div>
                            <div class="stat-label">Podios</div>
                        </div>
                        <div class="stat-item toggle-modal" data-list="poles">
                            <i class="fa-solid fa-stopwatch stat-icon"></i>
                            <div class="stat-value">${poles.length}</div>
                            <div class="stat-label">Poles</div>
                        </div>
                        <div class="stat-item toggle-modal" data-list="fastLaps">
                            <i class="fa-solid fa-bolt stat-icon"></i>
                            <div class="stat-value">${fastestLaps.length}</div>
                            <div class="stat-label">Mejor Vuelta</div>
                        </div>
                    </div>
                    
                    <div class="points-box">
                        <h2>PUNTOS TOTALES</h2>
                        <div class="points-lg">${driverStats.points}</div>
                    </div>
                    
                </div>
            `;

            contentDiv.innerHTML = profileHTML;

            // Activar la interactividad de la Modal despu√©s de renderizar
            activateModalDetails(driverRaceHistory);
        }

        function activateModalDetails(driverRaceHistory) {
            // Guardar el historial para que sea accesible al hacer clic
            CURRENT_DRIVER_HISTORY = driverRaceHistory;

            const modal = document.getElementById('detailModal');
            const closeButton = document.querySelector('.close-button');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body-content');

            // L√≥gica para cerrar la modal
            closeButton.onclick = () => {
                modal.style.display = 'none';
            };
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };

            // L√≥gica para abrir la modal al hacer clic en un stat-item
            document.querySelectorAll('.toggle-modal').forEach(button => {
                button.addEventListener('click', () => {
                    const listType = button.getAttribute('data-list');
                    let listHTML = '';
                    let titleText = '';
                    let filteredEvents = [];

                    // L√≥gica de filtrado (usando el array guardado)
                    if (listType === 'victories') {
                        titleText = 'Detalle de Victorias';
                        filteredEvents = CURRENT_DRIVER_HISTORY.filter(r => r.position === 1);
                        listHTML = generateEventListHTML(filteredEvents, 'victorias');
                    } else if (listType === 'podiums') {
                        titleText = 'Detalle de Podios (Top 3)';
                        filteredEvents = CURRENT_DRIVER_HISTORY.filter(r => r.position > 0 && r.position <= 3);
                        listHTML = generateEventListHTML(filteredEvents, 'podios');
                    } else if (listType === 'poles') {
                        titleText = 'Detalle de Poles (P1 en Clasificaci√≥n)';
                        filteredEvents = CURRENT_DRIVER_HISTORY.filter(r => r.pole_pos === 1);
                        listHTML = generateEventListHTML(filteredEvents, 'poles');
                    } else if (listType === 'fastLaps') {
                        titleText = 'Historial de Vueltas R√°pidas Personales';
                        listHTML = generateFastestLapHTML(CURRENT_DRIVER_HISTORY);
                    }

                    modalTitle.textContent = titleText;
                    modalBody.innerHTML = listHTML;
                    modal.style.display = 'block'; // Mostrar la modal
                });
            });
        }

        // 4. Funci√≥n principal de carga
        async function loadDriverProfile() {
            const driverName = getDriverNameFromUrl();
            const contentDiv = document.getElementById('profile-content');

            if (!driverName) {
                contentDiv.innerHTML = '<div class="profile-card"><h1 style="color:#ef4444;">Error: No se especific√≥ un piloto.</h1></div>';
                return;
            }

            contentDiv.innerHTML = '<div style="text-align:center; color:#94a3b8;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando perfil...</div>';

            try {
                // CARGA SIMULT√ÅNEA DE AMBAS FUENTES
                const [responseClasificacion, responseResultados] = await Promise.all([
                    fetchWithRetry(SHEET_URL),
                    fetchWithRetry(RESULTS_URL)
                ]);

                const dataClasificacion = await responseClasificacion.text();
                const dataResultados = await responseResultados.text();

                const driversClasificacion = parseClasificacionCSV(dataClasificacion);
                const allResults = parseResultsCSV(dataResultados);

                // COMBINACI√ìN Y FILTRADO DE DATOS
                const targetDriverStats = driversClasificacion.find(d => d.name === driverName);

                const driverRaceHistory = allResults.filter(
                    (r) => r.name === driverName
                );

                if (!targetDriverStats) {
                    contentDiv.innerHTML = '<div class="profile-card"><h1 style="color:#ef4444;">¬°Error! Piloto no encontrado.</h1></div>';
                    return;
                }

                renderProfile(targetDriverStats, driverRaceHistory);

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                contentDiv.innerHTML = `<div class="profile-card"><h1 style="color:#ef4444;">Error de conexi√≥n.</h1><p>Verifica que ambas URL de CSV est√°n correctas.</p></div>`;
            }
        }

        function toggleMenu() {
            const toggleButton = document.querySelector('.menu-toggle');
            const navMenu = document.getElementById('mobile-menu');

            // Funci√≥n para cerrar el men√∫
            const closeMenu = () => {
                navMenu.setAttribute('data-visible', 'false');
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleButton.querySelector('i').className = 'fa-solid fa-bars';
            };

            // Funci√≥n para abrir/cerrar al hacer clic en el bot√≥n de hamburguesa
            const toggleMenu = () => {
                const isVisible = navMenu.getAttribute('data-visible') === 'true';

                navMenu.setAttribute('data-visible', String(!isVisible));
                toggleButton.setAttribute('aria-expanded', String(!isVisible));

                // Cambia el icono (de hamburguesa a X y viceversa)
                toggleButton.querySelector('i').className = isVisible ? 'fa-solid fa-bars' : '';
            };

            if (toggleButton && navMenu) {
                toggleButton.addEventListener('click', toggleMenu);

                // üÜï NUEVA L√ìGICA: Cerrar al hacer clic fuera del men√∫ o del bot√≥n
                document.addEventListener('click', (event) => {
                    const isMenuVisible = navMenu.getAttribute('data-visible') === 'true';

                    // Si el men√∫ NO est√° abierto, no hacemos nada.
                    if (!isMenuVisible) {
                        return;
                    }

                    // Si el clic NO fue dentro del bot√≥n de hamburguesa Y NO fue dentro del men√∫ mismo:
                    if (!navMenu.contains(event.target) && !toggleButton.contains(event.target)) {
                        closeMenu();
                    }
                });

                // Opcional: Cerrar el men√∫ si se hace clic en uno de los enlaces
                // Esto asegura que el men√∫ se oculte despu√©s de la navegaci√≥n.
                const navLinks = navMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', closeMenu);
                });
            }
        }

        // Iniciar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', loadDriverProfile);
        document.addEventListener('DOMContentLoaded', toggleMenu);
    </script>

</body>

</html>