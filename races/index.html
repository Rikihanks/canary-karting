<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Calendario de Carreras | CK</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles_carreras.css">
</head>

<body>
    <nav class="navbar-wrapper">
        <div class="navbar-top">
            <button class="menu-toggle" aria-controls="mobile-menu" aria-expanded="false">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="navbar-title"><i class="fa-solid fa-trophy"></i> Carreras</span>
        </div>

        <div id="mobile-menu" class="navbar-menu" data-visible="false">
            <div class="menu-header">
                <img src="../icons/50.png" alt="icon" class="app-icon"> <span class="app-name">Canary Karting</span>
            </div>
            <a href="../" class="nav-link">üèÜ Clasificaci√≥n</a>
            <a href="../inscripcion/" class="nav-link">üìù Preinscripci√≥n</a>
            <a href="../sorteo/" class="nav-link"><i class="fa-solid fa-dice"></i> Sorteo</a>
            <a href="../races/" class="nav-link"> üèéÔ∏è Carreras</a>
        </div>
    </nav>
    <div class="container">
        <br>
        <div id="calendar-list">
            <div class="loading-message"><i class="fa-solid fa-spinner fa-spin"></i> Cargando calendario...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN DE URLS Y DATOS
        // ==========================================

        // **IMPORTANTE: REEMPLAZA ESTA URL CON TU ENLACE REAL DEL CALENDARIO**
        const CALENDAR_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTq8sBXfzKkBmGEUxaqB57exxTbF_0yYsHVaRsQ2F7HzCXoMVK8zW8630R4vtSvRn590pj-N65vFQek/pub?output=csv";
        const CALENDAR_URL = `https://corsproxy.io/?url=${encodeURIComponent(CALENDAR_CSV_LINK)}`;

        // ==========================================
        // üöÄ FUNCIONES DE UTILIDAD Y PARSEO
        // ==========================================

        async function fetchCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            } catch (error) {
                console.error("Error al cargar el CSV:", error);
                document.getElementById('calendar-list').innerHTML = '<div class="error-message">Error al cargar los datos.</div>';
                return null;
            }
        }

        /**
         * Parsea el CSV del Calendario (ID_CIRCUITO, NOMBRE, FECHA).
         * Utiliza '\t' como separador si los datos vienen con ese formato.
         */
        function parseCalendarCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const events = [];

            for (let i = 1; i < lines.length; i++) {
                // Usamos la coma (,) como separador est√°ndar. Si usa tabulador, c√°mbialo a split('\t')
                const parts = lines[i].split(',');

                if (parts.length >= 3) {
                    events.push({
                        id_circuito: parts[0] ? parts[0].trim() : '',
                        nombre: parts[1] ? parts[1].trim() : 'Carrera sin nombre',
                        fecha: parts[2] ? parts[2].trim() : '',
                    });
                }
            }
            return events;
        }

        // ==========================================
        // üèÅ RENDERIZADO Y L√ìGICA DE CLIC
        // ==========================================

        function goToEventDetail(id_circuito, fecha, circuitName) {
            // Codificamos los valores para pasarlos de forma segura por la URL
            const encodedDate = encodeURIComponent(fecha);
            const encodedCircuitName = encodeURIComponent(circuitName);
            window.location.href = `race_detail.html?id=${id_circuito}&date=${encodedDate}&circuitName=${encodedCircuitName}`;
        }

        function renderCalendar(events) {
            const listDiv = document.getElementById('calendar-list');

            // Ordenar por fecha (esto requiere un parser de fechas m√°s complejo, 
            // por simplicidad se deja sin ordenar si la fecha es solo string)

            if (events.length === 0) {
                listDiv.innerHTML = '<p class="empty-message">No hay eventos programados.</p>';
                return;
            }

            let html = `<ul class="event-list">`;
            events.forEach(event => {
                html += `
                    <li class="event-item" 
                        onclick="goToEventDetail('${event.id_circuito}', '${event.fecha}', '${event.nombre}')">
                        
                        <div class="event-info">
                            <span class="event-date">${event.fecha}</span>
                            <span class="event-name">${event.nombre}</span>
                        </div>
                        <i class="fa-solid fa-chevron-right event-icon"></i>
                    </li>
                `;
            });
            html += `</ul>`;
            listDiv.innerHTML = html;
        }

        async function loadCalendar() {
            const csvText = await fetchCSV(CALENDAR_URL);
            if (csvText) {
                const events = parseCalendarCSV(csvText);
                renderCalendar(events);
            }
        }

        function toggleMenu() {
            const toggleButton = document.querySelector('.menu-toggle');
            const navMenu = document.getElementById('mobile-menu');

            // Funci√≥n para cerrar el men√∫
            const closeMenu = () => {
                navMenu.setAttribute('data-visible', 'false');
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleButton.querySelector('i').className = 'fa-solid fa-bars';
            };

            // Funci√≥n para abrir/cerrar al hacer clic en el bot√≥n de hamburguesa
            const toggleMenu = () => {
                const isVisible = navMenu.getAttribute('data-visible') === 'true';

                navMenu.setAttribute('data-visible', String(!isVisible));
                toggleButton.setAttribute('aria-expanded', String(!isVisible));

                // Cambia el icono (de hamburguesa a X y viceversa)
                toggleButton.querySelector('i').className = isVisible ? 'fa-solid fa-bars' : '';
            };

            if (toggleButton && navMenu) {
                toggleButton.addEventListener('click', toggleMenu);

                // üÜï NUEVA L√ìGICA: Cerrar al hacer clic fuera del men√∫ o del bot√≥n
                document.addEventListener('click', (event) => {
                    const isMenuVisible = navMenu.getAttribute('data-visible') === 'true';

                    // Si el men√∫ NO est√° abierto, no hacemos nada.
                    if (!isMenuVisible) {
                        return;
                    }

                    // Si el clic NO fue dentro del bot√≥n de hamburguesa Y NO fue dentro del men√∫ mismo:
                    if (!navMenu.contains(event.target) && !toggleButton.contains(event.target)) {
                        closeMenu();
                    }
                });

                // Opcional: Cerrar el men√∫ si se hace clic en uno de los enlaces
                // Esto asegura que el men√∫ se oculte despu√©s de la navegaci√≥n.
                const navLinks = navMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', closeMenu);
                });
            }
        }
        document.addEventListener('DOMContentLoaded', loadCalendar);
        document.addEventListener('DOMContentLoaded', toggleMenu);
    </script>

</body>

</html>